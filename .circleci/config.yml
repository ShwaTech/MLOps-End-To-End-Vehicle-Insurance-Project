version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.1.0

executors:
  linux-docker:
    docker:
    - image: cimg/base:2024.01

jobs:
  continuous-integration:
    executor: linux-docker
    steps:
    - checkout
    - aws-cli/setup:
        aws-access-key-id: AWS_ACCESS_KEY_ID
        aws-secret-access-key: AWS_SECRET_ACCESS_KEY
        aws-region: AWS_REGION
    - run:
        name: Login to Amazon ECR
        command: |
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
    - run:
        name: Build, tag, and push image to Amazon ECR
        command: |
          docker build -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:latest .
          docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:latest

workflows:
  deploy-to-ec2:
    jobs:
    - continuous-integration:
        context: Shwa-Vehicle-Secrets
